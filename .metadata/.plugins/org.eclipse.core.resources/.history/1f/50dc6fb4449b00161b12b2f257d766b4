#!/usr/bin/python
#coding=utf-8
'''
Created on 2015-12-15
@author: ymy
Copyright ymyjohnny@gmail.com
'''

import MySQLdb,pymongo
import datetime
import os
from sendmail import *


def get_solutionid(adx):
    conn=MySQLdb.connect(host="221.228.228.4",user="root",passwd="uqcqa8zd",db="dsp_backend")
    cursor = conn.cursor ()
    print adx
    #打印多少条记录
    sid =  cursor.execute("SELECT solutionID  from  virtual_smart_bid_param_view "  )
    #print count
    #打印具体内容
    info = cursor.fetchmany(sid)
    for i in info:
        mysqlsid =  i[0]
        yield mysqlsid

    cursor.close ()  
    conn.close ()  
#     
#打印一行，每执行1次，会向下移一行
#row = cursor.fetchone ()[2]
#print row

def mongo_connection_show(day,id):
        client=pymongo.MongoClient('221.228.228.72',27018)
        db=client.sdb
        conn=db.daily_sum
        #id = long(int(id))
        #print id
        for i in  conn.find({"date":day,'id':id}):
            yield i
        conn.close()

def mongo_show(row,keys):
    for item in row:
        return item[keys]
        
def mysql_price(date,id):
    conn=MySQLdb.connect(host="221.228.228.46",user="root",passwd="uqcqa8zd",db="bidder_report")
    cursor = conn.cursor ()
    #打印多少条记录
    print "test1"
    pricerow =  cursor.execute(" SELECT sum( pass_price ) FROM `solution_monitors` WHERE solutionid = %s  AND  dateline  LIKE 's%' "  % (id,date)  )
    print "test2"
    #print count
    #打印具体内容
    price = cursor.fetchmany(pricerow)
    for i in price:
        mysqlprice =  i[0]
        cursor.close ()  
        conn.close ()  
        return  mysqlprice

def main():
    day = datetime.datetime.today().strftime("%Y-%m-%d")
    date = datetime.datetime.now().strftime("%Y-%m-%d 00:00:00")
    adx = "taobao"
    print adx
    sid = get_solutionid(adx)
    sub = "%s  有出价没赢价" % day
    f = open('mail.txt','a') 
    for id in sid:
        print id
        print "idok"
        show = 'show'
        mongorow = mongo_connection_show(day,id)
        try:
            mongoshow = mongo_show(mongorow,show)        
            print mongoshow
            mysqlprice  = mysql_price(date,id)
            print mysqlprice
        except Exception:
            continue
            return Exception
        if mysqlprice < 10000:
            continue
        if mongoshow < 100 and mysqlprice > 10000 :
            fw = "%s mongoshow:%s price次数:%s  \n" % (id,mongoshow,mysqlprice)
            print id
            f.write(fw)
    f.close()
    f1 = open('mail.txt','r')
    if send_mail(mailto_list,sub,f1.read()):  #邮件主题和邮件内容
         print "done!"
    else:
         print "failed!"
    f1.close()
    os.remove('mail.txt')


if __name__ == '__main__':
    main()
